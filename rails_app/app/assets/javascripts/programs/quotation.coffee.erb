//= require programs/quotation_search
//= require programs/quotation_create

Ext.define 'QuotationView',
  extend: 'Ext.panel.Panel'
  border: false
  layout: 'card'#type: 'vbox', align: 'stretch'
  listeners:
    render: (me)->
      btn_create = me.down 'button[name=create]'

      btn_create.on 'click', ()->
        main_page = me.up 'panel[name=main_page]'
        #close_tool = main_page.down 'tool'
        #close_tool.setVisible false

        me.setLoading true
        me.show_form_page btn_create.text, "create", (error)->
          me.setLoading false

  get_form: (name, init)->
    console.log "get_form", init
    me = @
    Ext.create "QuotationCreate",
      init: init
      rest_client: me.rest_client

  add_filter: (name, type, caption)->
    me = @
    cmp = Ext.create 'Ext.panel.Panel',
      xtype: 'panel'
      layout: type: 'hbox', align: 'stretch'
      height: 70
      border: false
      items: [
        layout: type: 'vbox'#, align: 'stretch'
        border: false
        bodyPadding: '5 0 0 2'
        items: [
          xtype: 'button'
          text: text_fa_icon 'times', ''
          cls: 'filter_remove_btn'
          cmp: cmp
          handler: (btn)->
            me.filter_form.remove cmp
        ,
          flex: 1
          border: false 
        ]
      ,
        border: false
        layout: type: 'vbox' 
        margin: '5 0 0 5'
        items: [
          xtype: 'x_date_range'
          width: 200
          name: name
          captions: caption
        ]
      ]

    @filter_form.add cmp

  save_quotation: (form, callback)->
    me = @
    values = form.getValues()
    unless Ext.isEmpty values.id
      me.setLoading true
      me.rest_client.update values.id, 'quotation', {},
        (res)->
          me.setLoading false
          callback res.success
      ,
        ()->
          me.setLoading false
          callback false
      ,
        jsonData:
          data: values
    else
      me.setLoading true
      me.rest_client.create 'quotation', {},
        (res)->
          me.setLoading false
          callback res.success
      ,
        ()->
          me.setLoading false
          callback false
      ,
        jsonData:
          data: values

  show_form_page: (title, name, callback)->
    me = @

    main_page = me.up 'panel[name=main_page]'
    main_page.set_title main_page.getTitle() + " > #{title}"

    form_name = "form"
    form_name += "_#{name}" unless Ext.isEmpty name

    me.rest_client.create form_name, {},
      (res)->
        if res.success

          form = me.get_form name, res.data
        
          n = me.add  
            dockedItems: [
              xtype: 'toolbar'
              dock: 'top'
              items: [
                xtype: 'button'
                text: text_fa_icon 'save', 'Save'
                handler: (btn)->
                  return unless form.isValid()
                  Ext.Msg.show
                    title:'Save?'
                    message: "Save Quotation"
                    buttons: Ext.Msg.YESNO
                    icon: Ext.Msg.QUESTION
                    fn: (ans)->
                      if ans == 'yes'
                        me.save_quotation form, (success)->
                          if success
                            main_page.restore_title()
                            me.getLayout().setActiveItem 0
                            me.remove n

              ,
                xtype: 'button'
                text: text_fa_icon 'arrow-left', 'Back'
                handler: ()->
                  main_page.restore_title()
                  me.getLayout().setActiveItem 0
                  me.remove n
              ]
            ]
            layout: 'fit'
            items: form

          me.getLayout().setActiveItem n

        callback res.success
    ,
      ()->
        callback()

  initComponent: ->
    me = @ 

    store = Ext.create 'Ext.data.Store',
      fields: [
        'record_id', 'uuid', 'quotation_no', 
        {type: 'date', name: 'issue_date', dateFormat: "Y-m-d"}, 
        'exchange_rate', 'created_by', 'customer', 'freight_term',
        'item_code', 'sub_code', 
        {type: 'float', name: 'part_price'},
        'po_reference',
        'remark',
        {type: 'float', name: 'package_price'},
        'customer_code',
        'unit_price',
        'part_name',
        'model'
      ]
      autoLoad: true
      proxy:
        type: 'ajax'
        url: me.rest_client.url
        extraParams:
          method: 'list'
        reader:
          type: 'json'
          rootProperty: 'rows'
          totalProperty: 'total'
        listeners:
          exception: (request, result)->
            try
              response = Ext.JSON.decode result.responseText 
              unless response.success
                Ext.create('ErrorBox',
                  message: response.message
                  backtrace: response.backtrace
                  ).show()
            catch e
              Ext.Msg.alert '', result.responseText

    @grid = Ext.create 'Ext.grid.Panel',
      region: 'center'
      flex: 1
      store: store 
      dockedItems: [
        xtype: 'toolbar'
        dock: 'top'
        items: [
          xtype: 'button'
          text: text_fa_icon 'file', 'Create'
          name: 'create'
          name: 'create'
        ,
          xtype: 'button'
          text: text_fa_icon 'edit', 'View'
          disabled: true
        ]
      ,
        xtype: 'pagingtoolbar'
        store: store
        dock: 'bottom'
        displayInfo: true
      ]
      columns: [
        xtype: 'rownumberer'
        width: 45
      ,
        text: 'Quotation No.'
        dataIndex: 'quotation_no'
      ,
        text: 'Customer'
        dataIndex: 'customer'
      ,
        text: 'Create Person'
        dataIndex: 'created_by'
      ,
        text: 'Issue Date'
        dataIndex: 'issue_date'
        renderer: Ext.util.Format.dateRenderer('d/m/Y')
      ,
        text: 'Freight Term'
        dataIndex: 'freight_term'
      ,
        text: 'Exch.Rate'
        dataIndex: 'exchange_rate'
        align: 'right'
      ,
        text: 'Item Code'
        dataIndex: 'item_code'
      ,
        text: 'Model'
        dataIndex: 'model'
      ,
        text: 'Sub Code'
        dataIndex: 'sub_code'
      ,
        text: 'Customer code'
        dataIndex: 'customer_code'
      ,
        text: 'Part Name'
        dataIndex: 'part_name'
      ,
        text: 'Package Price'
        dataIndex: 'package_price'
        align: 'right'
      ,
        text: 'Total Price'
        dataIndex: 'total_price'
        align: 'right'
      ,
        text: 'Unit Price'
        dataIndex: 'unit_price'
        align: 'right'
      ,
        text: 'PO Reference'
        dataIndex: 'po_reference'
      ,
        text: 'Remark'
        dataIndex: 'remark'
      ,
        text: 'App.File'
        dataIndex: 'total_approve_file'
        align: 'right'
        renderer: Ext.util.Format.numberRenderer('0,000')
      ,
        text: 'Calc.File'
        dataIndex: 'total_calculate_file'
        align: 'right'
        renderer: Ext.util.Format.numberRenderer('0,000')
      ]

    @filter_form = Ext.create 'Ext.form.Panel',
      border: false
      autoScroll: true 
      layout: type: 'vbox', align: 'stretch'

    @items = [ 
      xtype: 'panel'
      border: false
      layout: 'border'
      items: [
        @grid
      ,
        xtype: 'panel'
        region: 'east'
        title: 'Filter'
        dockedItems: [
          xtype: 'toolbar'
          dock: 'top'
          items: [
            xtype: 'button'
            text: text_fa_icon 'plus', 'Add'
            menu: [
              text: 'Quotation No.'
              handler: ()->
                me.add_filter "xx", "", ["Quotation No."]
            ]
          ,
            xtype: 'button'
            text: text_fa_icon 'eraser', 'Clear', 'fa-flip'
            handler: ()->
              me.filter_form.removeAll()
          ,
            '->'
          ,
            xtype: 'button'
            text: text_fa_icon 'search', 'Search'
          ]
        ]
        width: 400
        collapsed: true
        collapsible: true
        layout: 'fit'
        items: [
          @filter_form
        ]
      ]
    ]
    @callParent arguments


Ext.define 'Program.quotation',
  extend: 'MainView'
  get_url: -> '<%= Pathname.new(__FILE__).to_s.split("javascripts")[1].to_s.split(".")[0] %>'
  get_title: -> 'Quotation'
  get_view: (init, fn)->
    fn Ext.create 'QuotationView', rest_client: @rest_client
